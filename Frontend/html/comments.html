<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comentários do Post</title>
  <link rel="stylesheet" href="/css/comments.css">

  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet" />
</head>
<body>
  <!-- Botão para voltar ao feed -->
  <header>
    <!-- Você pode adicionar conteúdo ao cabeçalho aqui -->
  </header>

  <!-- Conteúdo principal -->
  <main>
    <!-- Exibição do post original -->
    <div class="comments">
      <div class="botao-post">
        <button id="backToFeed"><img src="../assets/img/voltar2.png"></button>
  
        <section id="postSection">
          <div id="postContent"></div>
        </section>
      </div>

      <!-- Lista de comentários -->
      <section id="commentsSection">
        <ul id="commentsList"></ul>
      </section>
    </div>

    <!-- Formulário para adicionar novo comentário -->
    <form id="commentForm">
      <textarea id="newComment" placeholder="Escreva um comentário..." required></textarea>
      <button type="submit" class="botao-comentar">Comentar</button>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const postId = urlParams.get('postId');

      if (!postId) {
        alert('ID do post não encontrado!');
        window.location.href = '/feed';
        return;
      }

      const postContent = document.getElementById('postContent');
      const commentsList = document.getElementById('commentsList');
      const commentForm = document.getElementById('commentForm');
      const newCommentInput = document.getElementById('newComment');

      // Função para criar e exibir um comentário
      function displayComment(comment) {
        const commentItem = document.createElement('li');
        commentItem.innerHTML = `
          <div class="comment">
            <div class="userdata">
              <div class="imgUserPost">
                <img src="../assets/profile-pictures/${comment.user.profilePicture}" class="userfoto">
              </div>
              <p class="nick">${comment.user.nome}</p>
              <small class="hora">${new Date(comment.createdAt).toLocaleString()}</small>
            </div>
            <p class="conteudo-post">${comment.content}</p>
          </div>`;
        commentsList.prepend(commentItem); // Adiciona o comentário no topo da lista
      }

      // Função para buscar e exibir o post original
      async function fetchPost() {
        try {
          const response = await fetch(`/posts/${postId}`);
          if (!response.ok) {
            throw new Error(`Erro ${response.status}: Não foi possível carregar o post.`);
          }
          const post = await response.json();

          postContent.innerHTML = `
            <div class="infoUserPost">
              <img src="/assets/profile-pictures/${post.user.profilePicture}" alt="${post.user.nome}" class="perfil-post">
              <strong>${post.user.nome} (@${post.user.usernick})</strong>
              <p>${new Date(post.createdAt).toLocaleString()}</p>
            </div>
            <p>${post.content}</p>`;
        } catch (error) {
          console.error('Erro ao carregar o post:', error);
          alert('Erro ao carregar o post. Verifique os logs para mais informações.');
        }
      }

      // Função para salvar comentários no localStorage
      function saveCommentsToLocal(comments) {
        localStorage.setItem(`comments_${postId}`, JSON.stringify(comments));
      }

      // Função para carregar comentários do localStorage
      function loadCommentsFromLocal() {
        const comments = localStorage.getItem(`comments_${postId}`);
        return comments ? JSON.parse(comments) : [];
      }

      // Função para buscar e exibir os comentários
      async function fetchComments() {
        try {
          const response = await fetch(`/posts/${postId}/comments`);
          if (!response.ok) throw new Error('Erro ao buscar os comentários.');
          
          const comments = await response.json();
          commentsList.innerHTML = ''; // Limpa a lista de comentários
          
          if (comments.length === 0) {
            // Se não houver comentários, exibe a mensagem
            const noCommentsMessage = document.createElement('div');
            noCommentsMessage.textContent = 'Esse post não possui comentários.';
            noCommentsMessage.classList.add('no-comments-message'); // Adicione uma classe para estilização se necessário
            commentsList.appendChild(noCommentsMessage);
          } else {
            comments.forEach(displayComment);
          }
          
          // Salvar comentários no localStorage
          saveCommentsToLocal(comments);
        } catch (error) {
          console.error('Erro ao carregar comentários:', error);
          
          // Carregar comentários do localStorage se a API falhar
          const localComments = loadCommentsFromLocal();
          commentsList.innerHTML = ''; // Limpa a lista de comentários
          
          if (localComments.length > 0) {
            localComments.forEach(displayComment);
          } else {
            const noCommentsMessage = document.createElement('li');
            noCommentsMessage.textContent = 'Esse post não possui comentários.';
            noCommentsMessage.classList.add('no-comments-message'); // Adicione uma classe para estilização se necessário
            commentsList.appendChild(noCommentsMessage);
          }
        }
      }

      // Função para enviar um novo comentário
      commentForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const newComment = newCommentInput.value.trim();

        if (!newComment) {
          alert('O comentário não pode estar vazio.');
          return;
        }

        try {
          const response = await fetch(`/posts/${postId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newComment })
          });

          if (!response.ok) throw new Error('Erro ao enviar o comentário.');

          const createdComment = await response.json();
          newCommentInput.value = ''; // Limpar campo de texto
          displayComment(createdComment); // Adiciona o novo comentário ao topo da lista

          // Atualizar localStorage com o novo comentário
          const existingComments = loadCommentsFromLocal();
          existingComments.push(createdComment);
          saveCommentsToLocal(existingComments);

        } catch (error) {
          console.error('Erro ao enviar comentário:', error);
          alert('Não foi possível enviar o comentário.');
        }
      });

      document.getElementById('backToFeed').addEventListener('click', () => {
        window.location.href = '/feed';
      });

      // Carregar post e comentários ao iniciar a página
      fetchPost();
      fetchComments();
    });
  </script>

</body>
</html>